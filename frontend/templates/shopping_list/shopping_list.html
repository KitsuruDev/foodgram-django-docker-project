{% extends 'base.html' %}
{% load static %}

{% block title %}–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ - Foodgram{% endblock %}

{% block content %}
<div class="container shopping-container">
    <div class="shopping-header">
        <h1>–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</h1>
        <div class="shopping-actions">
            <button onclick="downloadShoppingList('txt')" class="btn-download">üì• TXT</button>
            <button onclick="downloadShoppingList('pdf')" class="btn-download">üì• PDF</button>
            <button onclick="clearShoppingList()" class="btn-clear">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        </div>
    </div>
    
    {% if recipes %}
    <div class="shopping-stats">
        <p>–í—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤: <strong>{{ recipes_count }}</strong></p>
        <p>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –≤ —Å–ø–∏—Å–∫–µ: <strong>{{ ingredients_count }}</strong></p>
    </div>
    
    <div class="shopping-content">
        <div class="recipes-section">
            <h2>–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã</h2>
            <div class="selected-recipes">
                {% for recipe in recipes %}
                <div class="selected-recipe">
                    <a href="{% url 'detail_recipe' recipe.id %}" class="recipe-link">
                        {% if recipe.image %}
                            <img src="{{ recipe.image.url }}" alt="{{ recipe.title }}">
                        {% endif %}
                        <span>{{ recipe.title }}</span>
                    </a>
                    <button class="remove-recipe" data-recipe-id="{{ recipe.id }}">√ó</button>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="ingredients-section">
            <h2>–°–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤</h2>
            <div class="ingredients-list">
                {% for ingredient in ingredients %}
                <div class="ingredient-item">
                    <div class="ingredient-info">
                        <span class="ingredient-name">{{ ingredient.name }}</span>
                        <span class="ingredient-unit">{{ ingredient.measurement_unit }}</span>
                    </div>
                    <div class="ingredient-amount">
                        <strong>{{ ingredient.total_amount|floatformat:"-2" }}</strong>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    {% else %}
    <div class="empty-state">
        <img src="{% static 'images/empty-cart.svg' %}" alt="–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –ø—É—Å—Ç">
        <h3>–í–∞—à —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –ø—É—Å—Ç</h3>
        <p>–î–æ–±–∞–≤–ª—è–π—Ç–µ —Ä–µ—Ü–µ–ø—Ç—ã, –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É "–í –ø–æ–∫—É–ø–∫–∏"</p>
        <a href="{% url 'index' %}" class="btn-primary">–ù–∞–π—Ç–∏ —Ä–µ—Ü–µ–ø—Ç—ã</a>
    </div>
    {% endif %}
</div>

<script>
function clearShoppingList() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫?')) {
        fetch('{% url "shopping_list:clear" %}', {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    }
}

document.querySelectorAll('.remove-recipe').forEach(button => {
    button.addEventListener('click', function() {
        const recipeId = this.dataset.recipeId;
        
        fetch(`{% url "shopping_list:remove" %}?recipe_id=${recipeId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    });
});
</script>
{% endblock %}