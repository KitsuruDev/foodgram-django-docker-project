{% extends 'base.html' %}
{% load static %}

{% block title %}{{ recipe.title }} - Foodgram{% endblock %}

{% block content %}
<div class="container recipe-detail">
    <div class="recipe-header">
        <div class="recipe-image">
            {% if recipe.image %}
                <img src="{{ recipe.image.url }}" alt="{{ recipe.title }}">
            {% else %}
                <img src="{% static 'images/default-recipe.jpg' %}" alt="Default recipe image">
            {% endif %}
            
            {% if user.is_authenticated %}
            <div class="recipe-actions-top">
                <button class="favorite-btn" data-recipe-id="{{ recipe.id }}">
                    {% if recipe.is_favorited %}‚òÖ –£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ{% else %}‚òÜ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ{% endif %}
                </button>
                <button class="shopping-btn" data-recipe-id="{{ recipe.id }}">
                    {% if recipe.is_in_shopping_cart %}‚úì –í —Å–ø–∏—Å–∫–µ{% else %}Ôºã –í –ø–æ–∫—É–ø–∫–∏{% endif %}
                </button>
                
                {% if user == recipe.author %}
                <a href="{% url 'recipes:edit' recipe.id %}" class="btn-edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                <button class="btn-delete" onclick="confirmDelete()">–£–¥–∞–ª–∏—Ç—å</button>
                {% endif %}
            </div>
            {% endif %}
        </div>
        
        <div class="recipe-info">
            <h1>{{ recipe.title }}</h1>
            
            <div class="recipe-meta">
                <div class="author-info">
                    <a href="{% url 'users:profile' recipe.author.username %}" class="author-link">
                        {% if recipe.author.profile.avatar %}
                            <img src="{{ recipe.author.profile.avatar.url }}" alt="–ê–≤–∞—Ç–∞—Ä" class="author-avatar">
                        {% endif %}
                        <span>{{ recipe.author.get_full_name }}</span>
                    </a>
                    {% if user.is_authenticated and user != recipe.author %}
                    <button class="subscribe-btn" data-author-id="{{ recipe.author.id }}">
                        {% if is_subscribed %}‚úì –ü–æ–¥–ø–∏—Å–∞–Ω{% else %}Ôºã –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è{% endif %}
                    </button>
                    {% endif %}
                </div>
                
                <div class="recipe-stats">
                    <span class="stat-item">‚è±Ô∏è {{ recipe.cooking_time }} –º–∏–Ω</span>
                    <span class="stat-item">üëÅÔ∏è {{ recipe.views }} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</span>
                    <span class="stat-item">‚ù§Ô∏è {{ recipe.favorites_count }} –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="recipe-content">
        <div class="ingredients-section">
            <h2>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</h2>
            <ul class="ingredients-list">
                {% for ingredient in recipe.recipe_ingredients.all %}
                <li>
                    <span class="ingredient-name">{{ ingredient.ingredient.name }}</span>
                    <span class="ingredient-amount">{{ ingredient.amount }} {{ ingredient.ingredient.measurement_unit }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
        
        <div class="instructions-section">
            <h2>–û–ø–∏—Å–∞–Ω–∏–µ</h2>
            <div class="recipe-description">
                {{ recipe.description|linebreaks }}
            </div>
            
            {% if recipe.tags.all %}
            <div class="recipe-tags">
                {% for tag in recipe.tags.all %}
                <span class="tag-mini tag-{{ tag.name|slugify }}">{{ tag.name|slice:"3" }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="recipe-share">
        <button class="btn-share" onclick="copyRecipeLink()">
            üîó –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
        </button>
        <span id="copy-message" style="display: none; color: green; margin-left: 10px;">–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!</span>
    </div>
</div>

<script>
function copyRecipeLink() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
        const message = document.getElementById('copy-message');
        message.style.display = 'inline';
        setTimeout(() => {
            message.style.display = 'none';
        }, 2000);
    });
}

function confirmDelete() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–µ—Ü–µ–ø—Ç?')) {
        fetch('{% url "recipes:delete" recipe.id %}', {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => {
            if (response.ok) {
                window.location.href = '{% url "index" %}';
            }
        });
    }
}
</script>
{% endblock %}